<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Scanner</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23a0a0a0' d='M50,5A45,45,0,1,0,95,50,45,45,0,0,0,50,5Zm0,82A37,37,0,1,1,87,50,37,37,0,0,1,50,87Z'/%3E%3Cpath fill='%23c7c7c7' d='M50,15A35,35,0,0,0,15,50a4.5,4.5,0,0,0,9,0A26,26,0,0,1,50,24a4.5,4.5,0,0,0,0-9Z'/%3E%3Ccircle fill='%23c7c7c7' cx='50' cy='50' r='8'/%3E%3C/svg%3E">
</head>
<body>
    <div class="container">
        <header>
            <h1>Proxy Scanner</h1>
        </header>

        <div class="input-area">
            <textarea id="server-list" rows="10" placeholder="vless://..."></textarea>
            <div class="controls">
                <button id="scan-btn">Начать сканирование</button>
                <button id="clear-btn" class="secondary">Очистить</button>
            </div>
        </div>
        
        <div id="progress-container" class="hidden">
            <div class="progress-bar-wrapper">
                <div id="progress-bar"></div>
            </div>
            <div class="progress-text">
                <span id="progress-status"></span>
                <span id="eta"></span>
            </div>
        </div>

        <div id="results-container" class="hidden">
            <h2>Результаты</h2>
            <div id="results-table"></div>
            <div class="actions">
                <button id="save-selected-btn">Сохранить выбранные</button>
                <button id="copy-selected-btn">Копировать выбранные</button>
            </div>
        </div>

    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const scanBtn = document.getElementById('scan-btn');
        const clearBtn = document.getElementById('clear-btn');
        const serverListInput = document.getElementById('server-list');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        const etaDisplay = document.getElementById('eta');
        const resultsContainer = document.getElementById('results-container');
        const resultsTable = document.getElementById('results-table');
        const saveSelectedBtn = document.getElementById('save-selected-btn');
        const copySelectedBtn = document.getElementById('copy-selected-btn');
        
        let scanStartTime = 0;
        let resultsBuffer = [];
        let isUpdateScheduled = false;
        let abortController;

        const EUROPE_SORTED_BY_PSKOV = [
            'LV', 'EE', 'BY', 'FI', 'LT', 'PL', 'SE', 'UA', 'SK', 'CZ',
            'HU', 'RO', 'MD', 'NO', 'DK', 'DE', 'AT', 'RS', 'HR', 'BA', 'SI',
            'IT', 'AL', 'MK', 'GR', 'BG', 'SM', 'VA', 'ME', 'CH', 'LI', 'LU',
            'BE', 'NL', 'AD', 'MC', 'MT', 'GB', 'IE', 'FR', 'ES', 'PT', 'IS',
            'GI', 'FO', 'GE', 'AM', 'TR', 'CY'
        ];
        const EUROPE_COUNTRY_CODES = new Set(EUROPE_SORTED_BY_PSKOV);
        // RU теперь обрабатывается отдельно, поэтому он не в этом списке

        clearBtn.addEventListener('click', () => {
            serverListInput.value = '';
            resultsContainer.classList.add('hidden');
            progressContainer.classList.add('hidden');
            resultsTable.innerHTML = '';
            scanBtn.disabled = false;
        });

        scanBtn.addEventListener('click', async () => {
            if (scanBtn.classList.contains('stop-btn')) {
                abortController?.abort();
                finishScan(true);
                return;
            }
            const servers = serverListInput.value.trim().split('\n').filter(s => s.trim() !== '');
            if (servers.length === 0) {
                alert('Пожалуйста, вставьте список серверов.');
                return;
            }
            abortController = new AbortController();
            setupNewScan(servers.length);
            
            try {
                const response = await fetch('/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ servers }),
                    signal: abortController.signal
                });
                await processStream(response.body.getReader(), servers.length);
            } catch (error) {
                if (error.name !== 'AbortError') {
                     console.error('Scan failed:', error);
                     alert('Критическая ошибка сканирования.');
                }
            } finally {
                finishScan(false);
            }
        });
        
        resultsTable.addEventListener('click', (event) => {
            const row = event.target.closest('tr');
            if (!row && !event.target.classList.contains('group-checkbox')) return;
            if (event.target.type === 'checkbox') {
                if (event.target.classList.contains('group-checkbox')) {
                    const group = event.target.closest('.country-group');
                    const isChecked = event.target.checked;
                    group.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
                }
            } else if (row && !row.querySelector('.group-checkbox')) {
                const checkbox = row.querySelector('.row-checkbox');
                if (checkbox) checkbox.checked = !checkbox.checked;
            }
        });
        
        saveSelectedBtn.addEventListener('click', handleSave);
        copySelectedBtn.addEventListener('click', handleCopy);

        function setupNewScan(totalServers) {
            resultsContainer.classList.add('hidden');
            resultsTable.innerHTML = '';
            resultsBuffer = [];
            scanStartTime = Date.now();
            updateProgress(0, totalServers);
            progressContainer.classList.remove('hidden');
            clearBtn.disabled = true;
            scanBtn.textContent = 'Остановить сканирование';
            scanBtn.classList.add('stop-btn');
        }

        async function processStream(reader, totalServers) {
            const decoder = new TextDecoder();
            let processedCount = 0;
            let buffer = '';
            while (true) {
                const { done, value } = await reader.read();
                if (done) {
                    if (buffer.startsWith('data:')) {
                         try {
                            const data = JSON.parse(buffer.substring(5));
                            if (data.status === 'SUCCESS') resultsBuffer.push(data);
                        } catch (e) { console.error("Failed to parse final buffer:", buffer, e); }
                    }
                    updateProgress(processedCount + resultsBuffer.length, totalServers);
                    break;
                }
                buffer += decoder.decode(value, { stream: true });
                let boundary;
                while ((boundary = buffer.indexOf('\n\n')) >= 0) {
                    const message = buffer.substring(0, boundary);
                    buffer = buffer.substring(boundary + 2);
                    if (message.startsWith('data:')) {
                        processedCount++;
                        try {
                            const data = JSON.parse(message.substring(5));
                            if (data.status === 'SUCCESS') resultsBuffer.push(data);
                        } catch (e) { console.error("Failed to parse event:", message, e); }
                    }
                }
                updateProgress(processedCount, totalServers);
                if (!isUpdateScheduled && resultsBuffer.length > 0) {
                    isUpdateScheduled = true;
                    requestAnimationFrame(renderBufferedResults);
                }
            }
        }

        function finishScan(wasAborted) {
            renderBufferedResults();
            if (resultsTable.children.length > 0) {
                 resultsContainer.classList.remove('hidden');
                 sortAllResults();
            } else if (!wasAborted) {
                alert('Не найдено ни одного подходящего сервера.');
            }
            progressContainer.classList.add('hidden');
            clearBtn.disabled = false;
            scanBtn.textContent = 'Начать сканирование';
            scanBtn.classList.remove('stop-btn');
        }
        
        function renderBufferedResults() {
            if (resultsBuffer.length === 0) { isUpdateScheduled = false; return; }
            const itemsToRender = resultsBuffer.splice(0);
            const fragment = document.createDocumentFragment();
            for (const result of itemsToRender) {
                const groupContainer = getOrCreateGroupContainer(result, fragment); 
                const tbody = groupContainer.querySelector('tbody');
                const row = document.createElement('tr');
                row.dataset.uri = result.uri;
                row.dataset.countryCode = result.country_code;
                row.innerHTML = `<td><input type="checkbox" class="row-checkbox"></td><td>${result.remarks}</td>`;
                tbody.appendChild(row);
                const countSpan = groupContainer.querySelector('.server-count');
                countSpan.textContent = parseInt(countSpan.textContent) + 1;
            }
            resultsTable.appendChild(fragment);
            isUpdateScheduled = false;
        }

        function getOrCreateGroupContainer(result, fragment) {
            const groupId = `group-${result.country_code}`;
            let groupContainer = document.getElementById(groupId) || fragment.querySelector(`#${groupId}`);
            if (!groupContainer) {
                groupContainer = document.createElement('div');
                groupContainer.className = 'country-group';
                groupContainer.id = groupId;
                groupContainer.dataset.countryCode = result.country_code;
                // ИЗМЕНЕНО: Удален flag и пробелы вокруг счетчика
                groupContainer.innerHTML = `<div class="country-header"><h3>${result.country}(<span class="server-count">0</span>)</h3></div><div class="table-wrapper"><table><tbody><tr><td><input type="checkbox" class="group-checkbox"></td><td>Выбрать все</td></tr></tbody></table></div>`;
                fragment.appendChild(groupContainer);
            }
            return groupContainer;
        }

        // --- ИЗМЕНЕНА ВСЯ ЛОГИКА СОРТИРОВКИ ---
        function sortAllResults() {
            // Вспомогательная функция для определения ранга сортировки
            const getSortRank = (code) => {
                if (EUROPE_COUNTRY_CODES.has(code)) return 0; // Европа (кроме РФ)
                if (code === 'RU') return 1;                   // Россия
                if (code === 'ZZZ') return 3;                  // Неизвестно
                return 2;                                      // Все остальные
            };

            const groups = Array.from(resultsTable.querySelectorAll('.country-group'));
            groups.sort((a, b) => {
                const aCode = a.dataset.countryCode;
                const bCode = b.dataset.countryCode;

                const aRank = getSortRank(aCode);
                const bRank = getSortRank(bCode);

                // 1. Сортируем по рангу
                if (aRank !== bRank) {
                    return aRank - bRank;
                }

                // 2. Если ранг одинаковый, применяем вторичную сортировку
                // Для Европы - по списку удаленности от Пскова
                if (aRank === 0) {
                    return EUROPE_SORTED_BY_PSKOV.indexOf(aCode) - EUROPE_SORTED_BY_PSKOV.indexOf(bCode);
                }

                // Для "Остальных" - по алфавиту
                if (aRank === 2) {
                    const aName = a.querySelector('h3').textContent.trim();
                    const bName = b.querySelector('h3').textContent.trim();
                    return aName.localeCompare(bName);
                }
                
                // Для России и Неизвестных вторичная сортировка не нужна
                return 0;
            });
            // Применяем отсортированный порядок к DOM
            groups.forEach(group => resultsTable.appendChild(group));
        }

        function updateProgress(processed, total) {
            const percentage = total > 0 ? (processed / total) * 100 : 0;
            progressBar.style.width = `${percentage}%`;
            progressStatus.textContent = `Обработано ${processed} из ${total}`;
            if (processed > 5 && processed < total) {
                const elapsedSeconds = (Date.now() - scanStartTime) / 1000;
                const timePerServer = elapsedSeconds / processed;
                const remainingTime = Math.round((total - processed) * timePerServer);
                if (remainingTime > 0) {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    etaDisplay.textContent = `~ ${minutes > 0 ? `${minutes} мин ` : ''}${seconds} сек. осталось`;
                } else { etaDisplay.textContent = ''; }
            } else { etaDisplay.textContent = ''; }
        }

        function getSelectedServers() {
            return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => {
                const row = cb.closest('tr');
                return { uri: row.dataset.uri, country_code: row.dataset.countryCode };
            });
        }
        
        async function handleSave() {
            const servers = getSelectedServers();
            if (servers.length === 0) { alert('Не выбрано ни одного сервера для сохранения.'); return; }
            try {
                const response = await fetch('/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ servers })
                });
                const result = await response.json();
                alert(response.ok ? result.message : `Ошибка: ${result.message}`);
            } catch (error) {
                console.error('Save failed:', error);
                alert('Произошла ошибка при сохранении файла.');
            }
        }
        
        function handleCopy() {
            const uris = getSelectedServers().map(s => s.uri);
            if (uris.length > 0) {
                navigator.clipboard.writeText(uris.join('\n'))
                    .then(() => alert(`${uris.length} URI скопировано в буфер обмена!`))
                    .catch(err => { console.error('Copy failed', err); alert('Не удалось скопировать.'); });
            } else { alert('Не выбрано ни одного сервера.'); }
        }
    });
    </script>
</body>
</html>